# Low Latency Memory (LLM)

This repository includes code base required to reprouduce experiments conducted
as part of research and development for the Low Latency Memory (LLM).

LLM has been modeled and simulated in the gem5 simulator.
We will be using configuration scripts to drive gem5 for our simulations.

We will discuss the following in this readme.
**NOTE**: This tutorial has been tested with ubuntu 22.04.

* [How to build gem5](#how-to-build-gem5).
* [How to use gem5](#how-to-use-gem5).
* [How to run experiments](#how-to-run-experiments).

## How to build gem5

In order to build gem5, we will require a collection of dependencies.
Install the dependencies using the following command.

### Installing dependencies

```shell
sudo apt install build-essential git m4 scons zlib1g zlib1g-dev \
    libprotobuf-dev protobuf-compiler libprotoc-dev libgoogle-perftools-dev \
    python3-dev libboost-all-dev pkg-config
```

### Compiling gem5

The gem5 directory is in this repository is a submodule checked out at a commit
that includes the source code for LLM.
In order to compile gem5 for our experiments, run the following command
**inside** the gem5 directory.
**NOTE**: Make sure to replace `#threads` to the number of threads you would
like to use to compile gem5.

```shell
scons build/NULL/gem5.opt -j [#threads]
```

This command will create a binary for the gem5 simulator under
`build/NULL/gem5.opt` in the gem5 directory.

## How to use gem5

To run simulations with gem5, we will pass a python like script
(we will refer to this script as the config script)
to the gem5 binary as input.
This script will accomplish the following goals:

* Describe the system we need to simulate.
* Set a benchmark to use as the workload for the experiment.
* Handle data collection and controling the simulation.

This script could as well take input arguments from the command like to allow
for reuse of the script for multiple purposes.
The template command below shows the usage of the simulator.

```shell
gem5/build/NULL/gem5.opt {gem5 flags} {path to config script} {input args to config script}
```

Below is a list of useful and common gem5 flags.

* `--outdir={path}`: Sets the output directory of the simluation to `path`.
* `-re`: Enables redirecting gem5's *stdout* and *stderr*
to files in the ouput directory.
* `--debug-flags={comma separated list of flags}`: Enables logging debug
statement from the execution of the simulator binary.
To see a list of all debug flags run ```gem5/build/NULL/gem5.opt --debug-help```

Runnig a simulation will generate a text file with the title `stats.txt` in
the output directory.

## How to run experiments

We will be running two sets of experiments as described below.

* We will be using GUPSGen, a gem5 SimObject modeling the memory trace
generated by [RandomAccess](https://hpcchallenge.org/projectsfiles/hpcc/RandomAccess.html) benchmark.
We will measure number of memory location updates as giga updates
per second (GUPS).
For details on how to run these experiments refer to [Running GUPSGen](#running-gupsgen).
* We will be using memory traces collected from running [GAP Benchmark Suite](https://github.com/sbeamer/gapbs)
and measure the execution time of each kernel.
For details on how to run these experiments refer to [Running GAPBS traces](#running-gapbs).

### Running GUPSGen

This set of experiments tests different memory models with memory traffic
similar to that of [RandomAccess]() benchmark.
The config script to run these experiments is located under
`configs-gups-llm/run_llm_gups.py`.
This script requires the following as input arguments.

* `num_cores`: Specifies the number of generator
cores to generate memory traffic.
* `mem_type`: Specifies the type of DRAM to use.
**Valid Options** are as follows:
    * `LLM`: Low Latency Memory (This work).
    * `HBM: High Bandwidth Memory.
    * `HBMSALP`: HBM with the additon of sub-array level parallelism presented
    in this [academic paper](https://ieeexplore.ieee.org/abstract/document/6237032).
    * `FGDRAM`: A model of fine-grain DRAM presented in this
    [academic paper](https://dl.acm.org/doi/10.1145/3123939.3124545).
* `num_chnls`: Number of memory channels to simulate.
**NOTE**: Make sure to use `a power of 2` for this input.
This is a limitation of the gem5 simulator.
* `num_updates`: Specifies the number of updates (read, modify, write) to
produce.
Since running the benchmark to completion takes a long time, we recommend
using `100000` for this input.

Below is an example command line.
**NOTE**: Make sure to run this in the base directory of the repo.

```shell
gem5/build/NULL/gem5.opt configs-gups-llm/run_llm_gups.py 8 LLM 4 100000
```

### Running GAPBS

This set of experiments evaluates the performance of different memory models
using 6 kernels from [GAPBS](https://github.com/sbeamer/gapbs).
To run these experiments, we will need memory traces gathered from the
execution of each kernel.
To download these traces, run the following command.

```shell
wget {link to traces}
```

Make sure to decompress the downloaded file using the command below.

```shell
tar -xvzf {name of the file}
```

After decompressing the file, the traces could be located in the
`LLM_Mem_Traces` directory.
The directory is organized as follows.
```shell
LLM_Mem_Traces/
├── app_bc/
│   ├── FGDRAM
│   ├── HBM
│   ├── HBMSALP
│   └── LLM
├── app_bfs/
│   ├── FGDRAM
│   ├── HBM
│   ├── HBMSALP
│   └── LLM
├── app_cc/
│   ├── FGDRAM
│   ├── HBM
│   ├── HBMSALP
│   └── LLM
├── app_pr/
│   ├── FGDRAM
│   ├── HBM
│   ├── HBMSALP
│   └── LLM
├── app_sssp/
│   ├── FGDRAM
│   ├── HBM
│   ├── HBMSALP
│   └── LLM
└── app_tc/
    ├── FGDRAM
    ├── HBM
    ├── HBMSALP
    └── LLM
```

At the first level, each sub-directory includes traces that are specific to one
kernel of GAPBS.
Inside each sub-directory, there are 4 sub-directories each specific to one
memory model.

The config script to run these experiments is located in
`configs-gapbs-llm/run_llm_gapbs.py`.
This script requires the following as input arguments.

* `trace_dir`: The path to the directory including traces for the kernel and
memory model.
* `num_cores`: Number of cores to simulate.
* `num_chnls`: Number of memory channels to simulate.
**NOTE**: Make sure to use `a power of 2` for this input.
This is a limitation of the gem5 simulator.
* `chnl_cap`: Capacity of each channel of memory in Gigabytes.
We recommend using 16 for this input.
**NOTE**: This input does not influence the performance of the system.

Below is an example command line.
**NOTE**: Make sure to run this in the base directory of the repo.

```shell
gem5/build/NULL/gem5.opt configs-gapbs-llm/run_llm_gapbs.py LLM_Mem_Traces/app_bc/HBM 16 8 16
```
